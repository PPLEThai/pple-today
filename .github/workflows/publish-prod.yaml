name: Publish Production Image

on:
  workflow_dispatch:
    inputs:
      api:
        type: boolean
        description: 'Deploy API'
        default: false
      backoffice:
        type: boolean
        description: 'Deploy Backoffice'
        default: false
      ballot-crypto:
        type: boolean
        description: 'Deploy Ballot Crypto Service'
        default: false

jobs:
  get-affected-apps:
    name: Get affected applications
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.affected-apps.outputs.packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # fetch all history for tags
          persist-credentials: false # avoid checking out the repository again

      - name: Get affected web application names
        id: affected-apps
        run: |
          set -e

          if [[ "${{ github.ref }}" == "refs/tags"* ]]; then
            echo "Triggered on tag: ${GITHUB_REF}"
          else 
            echo "Error: This workflow can only be triggered on tags."
            exit 1
          fi

          function constructMetadata {
            NAME=$1
            PACKAGE_PATH=$2
            DOCKER_COMPOSE_PATH=$3
            REF=${{ github.ref }}
            IMAGE_TAG=${{ inputs.environment }}-$(cat $PACKAGE_PATH/package.json | jq -r '.version')

            ITEM="{
              \"name\": \"$NAME\",
              \"ref\": \"$REF\",
              \"imageTag\": \"$IMAGE_TAG\",
              \"path\": \"$PACKAGE_PATH\",
              \"version\": \"$IMAGE_TAG\",
              \"dockerComposePath\": \"$DOCKER_COMPOSE_PATH\"
            }"
            
            echo $ITEM
          }

          PACKAGES="[]"

          if [[ ${{ inputs.api }} == true ]]; then
            METADATA=$(constructMetadata "pple-api" "apps-api/backoffice" "docker-compose.api.yaml")
            PACKAGES=$(echo $PACKAGES | jq -c ". += [${METADATA}]")
          fi

          if [[ ${{ inputs.ballot-crypto }} == true ]]; then
              METADATA=$(constructMetadata "pple-ballot-crypto" "apps-api/ballot-crypto" "docker-compose.api.yaml")
              PACKAGES=$(echo $PACKAGES | jq -c ". += [${METADATA}]")
          fi

          if [[ ${{ inputs.backoffice }} == true ]]; then
              METADATA=$(constructMetadata "pple-backoffice" "apps-client/backoffice" "docker-compose.backoffice.yaml")
              PACKAGES=$(echo $PACKAGES | jq -c ". += [${METADATA}]")
          fi

          echo $PACKAGES | jq

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "packages=$PACKAGES"

  publish-prod:
    name: Publish Production Images
    runs-on: ubuntu-latest
    needs: get-affected-apps
    environment: production
    strategy:
      matrix:
        package: ${{ fromJson(needs.get-affected-apps.outputs.packages) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # fetch all history for tags
          persist-credentials: false # avoid checking out the repository again

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Google Artifact Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.GAR_REGISTRY }}
          username: ${{ secrets.GAR_USERNAME }}
          password: ${{ secrets.GAR_SERVICE_ACCOUNT }}

      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ${{ matrix.packages.path }}/Dockerfile
          platforms: linux/amd64
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            "VERSION=${{ matrix.packages.version }}"
            "LOCAL_ENV=${{ secrets.WEB_CLIENT_ENV_PRODUCTION }}"
          tags: ${{ secrets.GAR_REGISTRY }}/${{ secrets.GAR_REGISTRY_PREFIX }}/${{ matrix.package.name }}:${{ matrix.package.imageTag }}
